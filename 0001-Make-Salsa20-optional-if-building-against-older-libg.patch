From dc5de5699d9d637baaee6e0f71f4de9046e4a0fc Mon Sep 17 00:00:00 2001
From: Toni Spets <toni.spets@iki.fi>
Date: Sat, 18 Feb 2017 10:54:06 +0200
Subject: [PATCH] Make Salsa20 optional if building against older libgcrypt

---
 src/crypto/Crypto.cpp                | 2 ++
 src/crypto/SymmetricCipherGcrypt.cpp | 2 ++
 2 files changed, 4 insertions(+)

diff --git a/src/crypto/Crypto.cpp b/src/crypto/Crypto.cpp
index d00be72..9ebd2e5 100644
--- a/src/crypto/Crypto.cpp
+++ b/src/crypto/Crypto.cpp
@@ -90,11 +90,13 @@ bool Crypto::checkAlgorithms()
         qWarning("Crypto::checkAlgorithms: %s", qPrintable(m_errorStr));
         return false;
     }
+#if GCRYPT_VERSION_NUMBER >= 0x010600
     if (gcry_cipher_algo_info(GCRY_CIPHER_SALSA20, GCRYCTL_TEST_ALGO, nullptr, nullptr) != 0) {
         m_errorStr = "GCRY_CIPHER_SALSA20 not found.";
         qWarning("Crypto::checkAlgorithms: %s", qPrintable(m_errorStr));
         return false;
     }
+#endif
     if (gcry_md_test_algo(GCRY_MD_SHA256) != 0) {
         m_errorStr = "GCRY_MD_SHA256 not found.";
         qWarning("Crypto::checkAlgorithms: %s", qPrintable(m_errorStr));
diff --git a/src/crypto/SymmetricCipherGcrypt.cpp b/src/crypto/SymmetricCipherGcrypt.cpp
index cd43240..7f22caa 100644
--- a/src/crypto/SymmetricCipherGcrypt.cpp
+++ b/src/crypto/SymmetricCipherGcrypt.cpp
@@ -44,8 +44,10 @@ int SymmetricCipherGcrypt::gcryptAlgo(SymmetricCipher::Algorithm algo)
     case SymmetricCipher::Twofish:
         return GCRY_CIPHER_TWOFISH;
 
+#if GCRYPT_VERSION_NUMBER >= 0x010600
     case SymmetricCipher::Salsa20:
         return GCRY_CIPHER_SALSA20;
+#endif
 
     default:
         Q_ASSERT(false);
-- 
2.9.3

